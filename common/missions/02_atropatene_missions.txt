atropatene_mission_01 = {
    header = "persia_mission" # SPECIAL FIELD - Sets top picture for the mission
    icon = "general_2" # SPECIAL FIELD - Sets icon for the mission

    repeatable = no # SPECIAL FIELD - Sets if a mission can be done once or several times

    chance = {
        factor = 50000
    } # SPECIAL FIELD - Sets the chances of a mission appearing in your list of available missions

    potential = {
        NOT = { has_variable = atropatene_mission_cooldown }
        OR = {
            tag = MAP # TRIGGER FIELD - Sets the conditions for the mission to appear in your list
            AND = {
                tag = KIO
                has_variable = pontus_media_missions
            }
        }
        is_subject = no # must not be a subject
    }

    abort = {
        ai_mission_back_out_trigger = yes
    }
    
    on_start = {
        trigger_event = me_atropatene.45
        save_scope_as = me_atropatene_scope
        start_mission_ai_effect = yes
    } # EFFECT FIELD - These effects are run when the mission is started

    on_abort = {
        custom_tooltip = general_mission_cooldown_tt
        set_variable = {
            name = atropatene_mission_cooldown
            days = 1 #7300
        }
    } # EFFECT FIELD - These effects are run when the mission is aborted

    on_completion = {
        complete_mission_effect = yes
    } # EFFECT FIELD - These effects are run when the mission is completed

    atropatene_mission_01_task_01 = { # A State for the Medes
        icon = "task_expansion"

        allow = {
            trigger_if = {
                limit = {
                    tag = KIO
                }
                owns_percent_of_region = {
                    PROVINCE = "p:1571" # armenia_region
                    PERCENT = "0.75"
                }
            }
            custom_tooltip = {
                text = atropatene_mission_01_task_01_tt
                any_country_culture = {
                    is_culture = median
                    is_integrated = yes
                    OR = {
                        has_country_culture_modifier = trial_right
                        has_country_culture_modifier = land_protection
                        has_country_culture_modifier = citizenship_by_adoption
                    }
                }
            }
        }

        duration = 30

        on_completion = {
            if = {
                limit = {
                    tag = KIO
                }
                current_ruler = {
                    force_add_trait = conqueror
                    add_character_modifier = {
                        name = armenian_conqueror_mod
                        duration = 9125
                    }
                }
            }
            trigger_event = { id = me_atropatene.1 }
            hidden_effect = {
                if = {
                    limit = {
                        char:24 = { # Seleucus I Nicator
                            is_alive = no
                        }
                    }
                    set_variable = bypass_atropatene_mission_01_task_03
                }
            }
            show_as_tooltip = {
                add_country_modifier = {
                    name = state_for_the_medes
                    duration = 3650
                }
            }
        }
    }

    atropatene_mission_01_task_02 = { # The Birthplace of Zoroaster
       icon = "task_religion"

        allow = {
            political_influence >= 50
            treasury >= 200
        }

        highlight = {
            scope:province = {
                province_id = 1627
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.2 }

            show_as_tooltip = {
                add_political_influence = -50
                add_treasury = -200
                p:1627 = {
                    found_city_effect = yes
                }
            }
        }

    }

    atropatene_mission_01_task_03 = { # Strengthen the Median Identity
        icon = "task_diplomatic"
        requires = { atropatene_mission_01_task_15 }

        allow = {
            custom_tooltip = {
                text = atropatene_mission_01_task_03_tt
                any_owned_province = {
                    is_in_area = media_area
                    dominant_province_culture = root.culture
                }
                
                #area:media_area = {
                #    every_area_province = {
                #        dominant_province_culture = root.culture
                #    }
                #}
                #any_owned_province = {
                #    limit = {
                #        is_in_area = media_area
                #    }
                #    dominant_province_culture = root.culture
                #}
                #any_owned_province = {
                #    is_in_area = media_atropatene_area
                #    dominant_province_culture = root.culture
                #}
                #any_owned_province = {
                #    is_in_area = parskahayk_area
                #    dominant_province_culture = root.culture
                #}
            }
        }

        highlight = {
            scope:province = {
                OR = {
                    is_in_area = media_area
                    is_in_area = media_atropatene_area
                    is_in_area = parskahayk_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.3 }
            show_as_tooltip = {
                add_country_modifier = {
                    name = the_median_identity
                    duration = 3650
                }
            }
        }

    }

    atropatene_mission_01_task_04 = { # Prosperity of Glittering Salt
        icon = "task_economical"
        requires = { atropatene_mission_01_task_01 }

        highlight = {
			scope:province = {
                OR = {
                    province_id = 1648
                    province_id = 1630
                    province_id = 4985
                    province_id = 4986
                }
			}
        }

        allow = {
            hidden:p:1648 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1630 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:4985 = {
                has_construction = no
				has_building = population_building # Granary
            }
            hidden:p:4986 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.4 }

            show_as_tooltip = {
                p:1648 = {
                    add_province_modifier = {
                        name = prosperity_glittering_salt
                        duration = 3650
                    }
                }
                p:1630 = {
                    add_province_modifier = {
                        name = prosperity_glittering_salt
                        duration = 3650
                    }
                }
                p:4985 = {
                    add_province_modifier = {
                        name = prosperity_glittering_salt
                        duration = 3650
                    }
                }
                p:4986 = {
                    add_province_modifier = {
                        name = prosperity_glittering_salt
                        duration = 3650
                    }
                }
                area:parskahayk_area = {
                    add_provincial_claim_effect = yes
                }
                area:parsatunik_area = {
                    add_provincial_claim_effect = yes
                }
                area:hyrcania_area = {
                    add_provincial_claim_effect = yes
                }
                area:caucasian_albania_area = {
                    add_provincial_claim_effect = yes
                }
            }
        }

    }

    atropatene_mission_01_task_05 = { # The Holy City of Ganzak
        icon = "task_religion"
        requires = { atropatene_mission_01_task_02 }

        allow = {
            stability >= 55
            religious_unity >= 0.90
            hidden:p:1515 = {
                has_building = temple_building
                has_building = theathre_building
                custom_tooltip = { 
                    text = atropatene_mission_01_task_05_tt                   
                    any_pops_in_province = {
                        pop_type = citizen
                        count >= 10
                    }
                }
            }
        }

        highlight = {
            scope:province = {
                province_id = 1515
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.5 }
            show_as_tooltip = {
                add_country_modifier = {
                    name = the_holy_city
                    duration = -1
                }
            }
        }

    }

    atropatene_mission_01_task_06 = { # Mystical Kashmar
        icon = "task_expansion"
        requires = { atropatene_mission_01_task_02 }

        allow = {
            treasury >= 400
            manpower >= 2 # how is this 1000
            political_influence >= 30
            owns_or_subject_owns = 1571
            owns_or_subject_owns_area = parsatunik_area
            owns_or_subject_owns_area = soducene_area
        }

        highlight = {
            scope:province = {
                OR = {
                    province_id = 1571 # chosen for the large population it has
                    is_in_area = parsatunik_area
                    is_in_area = soducene_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.6 }

            show_as_tooltip = {
                current_ruler = { add_popularity = popularity_medium }
                add_legitimacy = 10
            }
        }

    }

    atropatene_mission_01_task_07 = { # Reinstate the Magi
        icon = "task_happiness"
        requires = { atropatene_mission_01_task_02 }

        allow = {
            # TODO check omen power for 110%
			custom_tooltip = {
				text = atropatene_mission_01_task_07_tt
				trigger_if = {
					limit = {
						any_character = { has_office = office_high_priest_monarchy }
					}
					any_character = {
						has_office = office_high_priest_monarchy
						loyalty >= 70
					}
				}
			}
            invention = gw_effect_zeal_education_inv # Has the invention Theological Colleges
            invention = omen_power_inv_4 # Has the invention Proscribed Canon
            invention = omen_duration_inv_1 # Has the invention Grand Temples
        }

        on_completion = {
            trigger_event = { id = me_atropatene.7 }

            show_as_tooltip = {
                add_country_modifier = {
                    name = reinstated_magi
                    duration = 3650
                }
                custom_tooltip = atropatene_mission_01_task_07_tt2
            }
        }

    }

    atropatene_mission_01_task_08 = { # For My Son
        icon = "task_conquest"
        requires = { atropatene_mission_01_task_01 }

        allow = {
            custom_tooltip = atropatene_mission_01_task_08_tt
            hidden:char:24 = { # Seleucus I Nicator
                is_alive = no
            } 
        }
        bypass = {
            has_variable = bypass_atropatene_mission_01_task_03
        }

        on_completion = {
            trigger_event = { id = me_atropatene.8 }

            show_as_tooltip = {
                current_ruler = { 
                    add_popularity = popularity_large 
                    force_add_trait = ambitious 
                    family = {
                        add_prestige = 100
                    }
                }
                c:MAP = {
                    add_country_modifier = {
                        name = seleukid_unrest
                        duration = 1825
                    }
                }
                c:SEL = {
                    add_country_modifier = {
                        name = death_of_seleucus
                        duration = 1095
                    }
                }
            }
        }

    }

    atropatene_mission_01_task_09 = { # The Atropatene Treasury
        icon = "task_economical"
        requires = { atropatene_mission_01_task_04 atropatene_mission_01_task_05 }

        allow = {
            p:1515 = {
                num_of_academy_building >= 2 # academy
                num_of_library_building >= 2 # library
                num_of_commerce_building >= 3 # marketplace
                num_of_town_hall_building >= 3 # Tax office

                custom_tooltip = { 
                    text = atropatene_mission_01_task_09_tt_1
                    any_pops_in_province = {
                        pop_type = nobles
                        count >= 5
                    }
                }
                custom_tooltip = { 
                    text = atropatene_mission_01_task_09_tt_2
                    any_pops_in_province = {
                        count >= 45
                    }
                }
            }
        }

        highlight = {
            scope:province = {
                province_id = 1515
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.9 }

            show_as_tooltip = {
                add_4_free_province_investments = yes
                add_innovation = 4
                add_political_influence = 100

                p:1515 = {
                    add_permanent_province_modifier = {
                        name = treasury_of_ganzak
                    }
                }
            }
        }
    }

    atropatene_mission_01_task_10 = { # Hunt for the Avesta
        icon = "task_battle"
        requires = { atropatene_mission_01_task_05 }

        allow = {
            manpower >= 10
            owns_or_subject_owns_area = persepolis_area
        }

        highlight = {
            scope:province = {
                OR = {
                    is_in_area = persepolis_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.10 }
            
            show_as_tooltip = {
                add_country_modifier = {
                    name = the_royal_library
                }
            }
        }
    }

    atropatene_mission_01_task_11 = { # Travels of the Royal Spirit
        icon = "task_happiness"
        requires = { atropatene_mission_01_task_06 }

        allow = {
            hidden:p:4985 = {
                has_building = temple_building
                has_building = forum_building

                custom_tooltip = { 
                    text = atropatene_mission_01_task_11_tt_1
                    any_pops_in_province = {
                        pop_type = nobles
                        count >= 4
                    }
                }
                custom_tooltip = { 
                    text = atropatene_mission_01_task_11_tt_2
                    any_pops_in_province = {
                        count >= 45
                    }
                }
            }
        }

        highlight = {
            scope:province = {
                province_id = 4985
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.11 }

            show_as_tooltip = {
                p:4985 = {
                    add_permanent_province_modifier = {
                        name = the_royal_spirit
                    }
                }
            }
        }
    }

    atropatene_mission_01_task_12 = { # The Faith of the Kadousioi
        icon = "task_religion"
        requires = { atropatene_mission_01_task_07 }

        allow = {
            has_law = heritage_tax_exemption
            area:kadousioi_area = {
                any_area_province = {
                    has_city_status = yes
                    has_building = temple_building
                    count >= 5  
                }
            }
            p:1627 = {
                treasure_count >=2
            }
        }

        highlight = {
            scope:province = {
                OR = {
                    province_id = 1627
                    is_in_area = kadousioi_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.12 }

            show_as_tooltip = {
                p:1627 = {
                    add_permanent_province_modifier = {
                        name = the_faith_of_kadousioi
                    }
                }
            }
        }
    }

    atropatene_mission_01_task_13 = { # Civilize the Cadusians
        icon = "task_diplomatic"
        requires = { atropatene_mission_01_task_08 }

        allow = {
            custom_tooltip = {
                text = atropatene_mission_01_task_13_tt
                any_owned_province = {
                    is_in_area = amardioi_area
                    dominant_province_culture = root.culture
                }
                any_owned_province = {
                    is_in_area = kadousioi_area
                    dominant_province_culture = root.culture
                }
            }
        }

        highlight = {
            scope:province = {
                OR = {
                    is_in_area = amardioi_area
                    is_in_area = kadousioi_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.13 }

            show_as_tooltip = {
                add_country_modifier = {
                    name = the_civilized_cadusians_global
                    duration = -1
                }
                area:amardioi_area = {
                    every_area_province = {
                        limit = {
                            owner = root
                            has_city_status = yes
                        }
                        create_state_pop = citizen
                        create_state_pop = citizen
                    }
                }
                area:kadousioi_area = {
                    every_area_province = {
                        limit = {
                            owner = root
                            has_city_status = yes
                        }
                        create_state_pop = citizen
                        create_state_pop = citizen
                    }
                }
                p:4985 = {
                    add_permanent_province_modifier = {
                        name = the_civilized_cadusians
                    }
                    create_state_pop = nobles
                    create_state_pop = nobles
                }
                p:1627 = {
                    add_permanent_province_modifier = {
                        name = the_civilized_cadusians
                    }
                    create_state_pop = nobles
                    create_state_pop = nobles
                }
            }
        }

    }

    atropatene_mission_01_task_14 = { # Claim to Media
        icon = "task_expansion"
        requires = { atropatene_mission_01_task_03 }

        allow = {
            has_law = work_for_the_best # Royal Guard - Legion Law
            legitimacy >= 75
        }

        on_completion = {
            trigger_event = { id = me_atropatene.14 }
            show_as_tooltip = {
                custom_tooltip = atropatene_mission_01_task_14_tt
            }
        }
    }

    atropatene_mission_01_task_15 = { # Consolidate Lake Matiene
        icon = "task_expansion"
        requires = { atropatene_mission_01_task_04 }

        highlight = {
            scope:province = {
                OR = {
                    is_in_area = parskahayk_area
                    is_in_area = parsatunik_area
                }
            }
        }

        allow = {
            owns_or_subject_owns_area = parsatunik_area
            owns_or_subject_owns_area = parskahayk_area
            hidden:p:1502 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1505 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1506 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1517 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1518 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
            hidden:p:1519 = {
                has_construction = no
				has_building = basic_settlement_infratructure_building # farming settlement
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.15 }
            add_4_free_province_investments = yes
            p:1503 = {
                found_city_effect = yes
                add_permanent_province_modifier = {
                    name = lake_matiene
                }
                create_state_pop = nobles
                create_state_pop = citizen
                create_state_pop = freemen
                create_state_pop = slaves
                create_state_pop = slaves
            }
            p:1516 = {
                found_city_effect = yes
                add_permanent_province_modifier = {
                    name = lake_matiene
                }
                create_state_pop = nobles
                create_state_pop = citizen
                create_state_pop = freemen
                create_state_pop = slaves
                create_state_pop = slaves
            }
        }

    }

    atropatene_mission_01_task_16 = { # The Metropolis of Media
        icon = "task_calm"
        requires = { atropatene_mission_01_task_09 }

        allow = {
            owns = 1595
            hidden:p:1595 = {
                has_province_rank = city_metropolis
                # TODO
                # has_monthly_income >= 0.1

                custom_tooltip = { 
                    text = atropatene_mission_01_task_16_tt_2
                    any_pops_in_province = {
                        pop_type = nobles
                        count >= 10
                    }
                }
            }
        }

        highlight = {
            scope:province = {
                province_id = 1595
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.16 }

            show_as_tooltip = {
                add_innovation = 4
                add_8_free_province_investments = yes
                add_political_influence = 75
                add_country_modifier = {
                    name = metropolis_of_media
                }
            }
        }

    }

    atropatene_mission_01_task_17 = { # The Obscurity of Druj
        icon = "task_religion"
        requires = { atropatene_mission_01_task_11 }
        prevented_by = { atropatene_mission_01_task_18 }
        bypass = { 
            OR = {
                has_variable = the_light_of_asha_variable # me_atropatene.38
                has_variable = atropatene_good
            }
         }

        duration = 365

        on_start = {
            # todo event chain
        }

        on_completion = {
            set_variable = {
                name = atropatene_bad
                days = -1
            }

            trigger_event = { id = me_atropatene.17 }

            show_as_tooltip = {
                current_ruler = {
                    add_character_modifier = {
                        name = obscurity_of_druj
                        duration = -1
                    }
                }
            }

        }

    }

    atropatene_mission_01_task_18 = { # The Light of Asha
        icon = "task_religion"
        requires = { atropatene_mission_01_task_11 }
        prevented_by = { atropatene_mission_01_task_17 }
        bypass = { 
            OR = {
                has_variable = the_obscurity_of_druj_variable # me_atropatene.39
                has_variable = atropatene_good
            }
         }

        duration = 365

        on_start = {
            # todo event chain
        }

        on_completion = {
            set_variable = {
                name = atropatene_good
                days = -1
            }
            trigger_event = { id = me_atropatene.18 }

            show_as_tooltip = {
                current_ruler = {
                    add_character_modifier = {
                        name = light_of_asha
                        duration = -1
                    }
                }
            }
        }
    }

    atropatene_mission_01_task_19 = { # A Holy Metropolis
        icon = "task_atlas"
        requires = { atropatene_mission_01_task_12 }

        allow = {
            treasury >= 300
            political_influence >= 50

            hidden:p:1627 = {
                treasure_count = 3
                custom_tooltip = { 
                    text = atropatene_mission_01_task_19_tt
                    any_pops_in_province = {
                        count >= 80
                    }
                }
                custom_tooltip = { 
                    text = atropatene_mission_01_task_19_tt_2
                    any_pops_in_province = {
                        pop_type = nobles
                        count >= 12
                    }
                }
            }  
           hidden:p:1627.state = {
                custom_tooltip = {
                    text = "atropatene_needs_four_religious_investments_tt"
                    calc_true_if = {
                        amount >= 1
                        state_improvement_religious_trigger = yes   
                    }
                }
            }
        }

        duration = 450

        highlight = {
            scope:province = {
                province_id = 1627
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.19 }

            show_as_tooltip = {
                add_treasury = -300
                add_political_influence = -50
                add_6_free_province_investments = yes
                add_innovation = 4
                p:1627 = {
                    set_city_status = city_metropolis
                    add_permanent_province_modifier = {
                        name = holy_metropolis_ardabil
                    }
                }
            }
        }

    }

    atropatene_mission_01_task_20 = { # Trade on the Mazandaran Sea
        icon = "task_expansion"
        requires = { atropatene_mission_01_task_13 }

        allow = {
            has_monthly_income >= 15
            AND = {
                owns = 4985
                hidden:p:4985 = { has_city_status = yes }
                owns = 4996
                hidden:p:1633 = { has_city_status = yes }
                owns = 4997
                hidden:p:4997 = { has_city_status = yes }
                owns = 3434
                hidden:p:3434 = { has_city_status = yes }
                owns = 3435
                hidden:p:3435 = { has_city_status = yes }
                owns = 1644
                hidden:p:1644 = { has_city_status = yes }
                owns = 1633
                hidden:p:1633 = { has_city_status = yes }
            }
        }

        highlight = {
            scope:province = {
                OR = {
                    province_id = 4985
                    province_id = 4996
                    province_id = 4997
                    province_id = 3434
                    province_id = 3435
                    province_id = 1644
                    province_id = 1633
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.20 }

            show_as_tooltip = {   # find a way to un-clutter this mess of a completion section.
                add_4_free_province_investments = yes
                add_innovation = 2
                p:4985 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:4996 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:4997 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:3434 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:3435 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:1644 = { add_permanent_province_modifier = { name = mazandaran_migration }  }
                p:1633 = { add_permanent_province_modifier = { name = mazandaran_migration }  }

                area:scythia_trans_montem_area = {
                    add_provincial_claim_effect = yes
                }
                area:sarmatia_hyrcania_area = {
                    add_provincial_claim_effect = yes
                }
                area:atara_area = {
                    add_provincial_claim_effect = yes
                }
                area:darn_area = {
                    add_provincial_claim_effect = yes
                }
                area:scythia_ultima_area = {
                    add_provincial_claim_effect = yes
                }
                area:scythia_ad_pontem_area = {
                    add_provincial_claim_effect = yes
                }
                area:dahaea_area = {
                    add_provincial_claim_effect = yes
                }
                area:parnia_area = {
                    add_provincial_claim_effect = yes
                }
                area:paytankert_area = {
                    add_provincial_claim_effect = yes
                }
            }
        }
    }

    atropatene_mission_01_task_21 = { # The Land of the Medes
        icon = "task_calm"
        requires = { atropatene_mission_01_task_14 }

        allow = {
            owns_region = media_region
            owns_area = hyrcania_area
            owns_area = parthia_komishene_area
            has_law = monarchy_religious_mandate_military
            has_law = public_notaries_law
        }

        duration = 365

        on_completion = {
            trigger_event = { id = me_atropatene.21 }
            declare_war_with_wargoal = {
                war_goal = imperial_conquest_wargoal
                target = SEL
            }
            show_as_tooltip = {

                add_political_influence = 75
                add_legitimacy = 15

                add_country_modifier = {
                    name = land_of_medes
                    duration = 3650
                }
                current_ruler = {
                    add_popularity = popularity_large 
                }
            }
        }
    }

    atropatene_mission_01_task_22 = { # Salty Success
        icon = "task_economical"
        requires = { atropatene_mission_01_task_15 }

        allow = {
            # 5 total province income in the parskayak and media atropatene provinces
            custom_tooltip = {
                text = atropatene_mission_01_task_22_tooltip
                atropatene_mission_01_task_22_money_current >= atropatene_mission_01_task_22_money_total
                atropatene_mission_01_task_22_unrest_current <= atropatene_mission_01_task_22_unrest_total
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.22 }

            show_as_tooltip = {
                add_6_free_province_investments = yes
                current_ruler = { add_popularity = popularity_medium }
                p:1515 = {
                    add_permanent_province_modifier = { name = salty_trade_routes }
                    create_state_pop = nobles
                    create_state_pop = nobles
                    create_state_pop = nobles
                    create_state_pop = nobles
                }
                area:parskahayk_area = {
                    every_area_province = {
                        limit = {
                            is_state_capital = yes
                        }
                        add_permanent_province_modifier = { name = salty_trade_routes }
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                    }
                }
                area:kadousioi_area = {
                    every_area_province = {
                        limit = {
                            is_state_capital = yes
                        }
                        add_permanent_province_modifier = { name = salty_trade_routes }
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                    }
                }
                area:amardioi_area = {
                    every_area_province = {
                        limit = {
                            is_state_capital = yes
                        }
                        add_permanent_province_modifier = { name = salty_trade_routes }
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                        create_state_pop = nobles
                    }
                }
            }
        }
    }

    atropatene_mission_01_task_23 = { # Penance
        icon = "task_happiness"
        requires = { atropatene_mission_01_task_17 }
        prevented_by = { atropatene_mission_01_task_18 }

        allow = {
            treasury >= 400
            political_influence >= 100

            # TODO Verify
			custom_tooltip = {
				text = atropatene_mission_01_task_23_tt
				trigger_if = {
					limit = {
						any_character = { has_office = office_bodyguard }
					}
					any_character = {
						has_office = office_bodyguard
						loyalty >= 80
					}
				}
			}
        }

        on_completion = {
            # TODO event chain
            trigger_event = { id = me_atropatene.23 }

            show_as_tooltip = {
                add_treasury = -400
                add_political_influence = -100
            }
        }

    }

    atropatene_mission_01_task_24 = { # TBD
        icon = "task_atlas"
        requires = { atropatene_mission_01_task_18 }
        prevented_by = { atropatene_mission_01_task_17 }

        allow = {
            treasury >= 200
            political_influence >= 100
            stability >= 50
        }

        on_completion = {
            trigger_event = { id = me_atropatene.24 }

            show_as_tooltip = {
                add_country_modifier = {
                    name = keeping_the_faith
                    duration = -1
                }
            }
        }

    }

    atropatene_mission_01_task_25 = { # Median Urbanization
        icon = "task_political"
        requires = { atropatene_mission_01_task_21 }

		allow = {
            has_monthly_income >= 20
			custom_tooltip = {
				text = atropatene_mission_01_task_25_tt
				num_of_commerce_building_total >= 60
			}
			custom_tooltip = {
				text = atropatene_mission_01_task_25_tt_1
				num_of_foundry_building_total >= 20
			}
			#p:1515.state = {
            #    local_state_trade_routes >=5
			#	incoming_trade_routes >= 7
			#	outgoing_trade_routes >= 7
			#}
			#p:3386.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3			
			#}
			#p:1593.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:4985.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:6954.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:1594.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:1595.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:4991.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
			#p:4973.state = {
			#	incoming_trade_routes >= 3
			#	outgoing_trade_routes >= 3
			#}
		}

        #highlight = {
        #    scope:province = {
        #        OR = {
        #            is_in_area = media_atropatene_area
        #            is_in_area = media_area
        #            is_in_area = kadousioi_area
        #            is_in_area = amardioi_area
        #            is_in_area = media_choromithrene
        #            is_in_area = kossioi_area
        #            is_in_area = ecbatana_area
        #            is_in_area = rhagai_area
        #            is_in_area = aspadana_area
        #        }
        #    }
        #}

        on_completion = {
            trigger_event = { id = me_atropatene.25 }

            show_as_tooltip = {
                add_innovation = 4		
                current_ruler = {
                    force_add_trait = intelligent
                }
                add_country_modifier = {
                    name = atropatene_urbanization
                    duration = -1
                }
            }
        }

    }

    atropatene_mission_01_task_26 = { # The kingdom of Cyaxares
        icon = "task_battle"
        requires = { atropatene_mission_01_task_21 }

        allow = {
            owns_region = cappadocia_pontica_region
            owns_region = armenia_region
            owns_region = media_region
            owns_region = parthia_region
            owns_region = ariana_region
            owns_region = persis_region
            owns_area = garamig_area

            root.current_ruler = {
                popularity >= 90
            }
            legitimacy >= 90

            has_law = king_of_kings
            has_law = royal_bureaucracy # Might of Majesty
            
        }

        highlight = {
            scope:province = {
                OR = {
                    is_in_region = cappadocia_pontica_region
                    is_in_region = armenia_region
                    is_in_region = media_region
                    is_in_region = parthia_region
                    is_in_region = ariana_region
                    is_in_region = persis_region
                    is_in_area = garamig_area
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.26 }

            show_as_tooltip = {
                add_12_free_province_investments = yes
                add_innovation = 4
                add_political_influence = 50
            }
        }

    }

    atropatene_mission_01_task_27 = { # Redeemed Scholar
        icon = "task_political"
        requires = { atropatene_mission_01_task_23 }
        prevented_by = { atropatene_mission_01_task_18 }

        allow = {
			custom_tooltip = {
				text = atropatene_mission_01_task_27_tt
				num_of_academy_building_total >= 33
			}
			custom_tooltip = {
				text = atropatene_mission_01_task_27_tt_2
				num_of_library_building_total >= 40
			}
            # TODO has research efficiency of GTE 150
        }

        on_completion = {
            trigger_event = { id = me_atropatene.27 }
            show_as_tooltip = {
                # todo remove negative trait from current ruler
                add_country_modifier = {
                    name = redeemed_scholar
                    duration = -1
                }
            }
        }

    }

    atropatene_mission_01_task_28 = { # Holy Bazaars
        icon = "task_religion"
        requires = { atropatene_mission_01_task_24 }
        prevented_by = { atropatene_mission_01_task_17 }

        allow = {
            treasury >= 400
            manpower >= 100

            p:1627 = {
                num_of_commerce_building >= 5
            }
            p:1515 = {
                num_of_commerce_building >= 5
            }
            p:3444 = {
                num_of_commerce_building >= 5
            }
        }

        highlight = {
            scope:province = {
                OR = {
                    province_id = 1627
                    province_id = 1515
                    province_id = 3444
                }
            }
        }

        on_completion = {
            add_treasury = -300
            p:1627 = {
                create_state_pop = nobles
                create_state_pop = citizen
            }
            p:1515 = {
                create_state_pop = nobles
                create_state_pop = citizen
            }
            p:3444 = {
                create_state_pop = nobles
                create_state_pop = citizen
            }
            add_country_modifier = {
                name = holy_bazaars
            }
            add_6_free_province_investments = yes
            add_political_influence = 50 
        }

    }

    atropatene_mission_01_task_29 = { # A Median Legacy
        icon = "task_heracles"
        requires = { atropatene_mission_01_task_26 }
        final = yes

        allow = {
            custom_tooltip = {
                text = atropatene_mission_01_task_29_tt
                owns = 1595  #Ecbatana
                owns = 1515  #Ganzak
                owns = 1593  #Miyana
                owns = 6954  #Qom
                OR = {
                    tag = MEE # Formed Greater Media
                    tag = PER # Formed Persia
                }
                
            }
            owns = 958
            political_influence >= 100
        }

        duration = 365
        
        highlight = {
            scope:province = {
                OR = {
                    province_id = 958
                    province_id = 1595
                    province_id = 1515
                    province_id = 1593
                    province_id = 6954
                }
            }
        }

        on_completion = {
            trigger_event = { id = me_atropatene.29 }

            show_as_tooltip = {
                add_military_experience = 150
                add_stability = 25
                add_political_influence = 200

                add_country_modifier = {
                    name = median_legacy
                }
            }

            remove_variable = the_obscurity_of_druj_variable
            remove_variable = the_light_of_asha_variable
            remove_variable = atropatene_bad
            remove_variable = atropatene_good
        }

    }

    atropatene_mission_01_task_30 = { # Imperial Zoroaster
        icon = "task_battle"
        requires = { atropatene_mission_01_task_24 }
        prevented_by = { atropatene_mission_01_task_17 }

        allow = {
            stability >= 75
            political_influence >= 100
            num_of_cities >= 300
        }

        duration = 30

        on_completion = {
            trigger_event = { id = me_atropatene.30 }

            show_as_tooltip = {
                change_government = imperium
                add_treasury = 500
                add_innovation = 4
                add_legitimacy = 20
                current_ruler = {
                    add_popularity = popularity_large
                }
            }
        }
    }

}