ai_fix_character_loyalty = {
    if = {
        limit = {
            is_ai = yes
            exists = current_ruler
            has_civil_war = no
        }

        # Required by character interaction triggers and effects
        save_scope_as = actor

        # Track how much loyalty fixing we already performed
        set_local_variable = {
            name = loyalty_fixes_done
            value = 0
        }

        # Urgently needs to fix loyalty
        if = {
            limit = {
                # Try to prevent civil war from happening
                towards_civil_war = yes
            }

            # Bribe up to 3 disloyal eligible characters with high power base
            if = {
                limit = {
                    country_uses_persuation_instead_of_bribing = yes
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        orator_bribe_character_potential_trigger = yes
                        orator_bribe_character_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_powerful = yes
                    }
                    # Results in 3 highest by power base
                    order_by = power_base
                    min = 0
                    max = 3
                    # Don't print errors if there are less characters
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    if = {
                        limit = {
                            # Re-check cause we are bribing multiple people so we could run out of PI and gold midway
                            orator_bribe_character_allowed_trigger = yes
                        }
                        orator_bribe_character = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
            else = {
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        bribe_character_potential_trigger = yes
                        bribe_character_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_powerful = yes
                    }
                    # Results in 3 highest by power base
                    order_by = power_base
                    min = 0
                    max = 3
                    # Don't print errors if there are less characters
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    if = {
                        limit = {
                            # Re-check cause we are bribing multiple people so we could run out of PI and gold midway
                            bribe_character_allowed_trigger = yes
                        }
                        bribe_character_effect = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If couldn't bribe 3 characters, give free hands to eligible character with highest power base
            if = {
                limit = {
                    local_var:loyalty_fixes_done < 3
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        free_hands_potential_trigger = yes
                        free_hands_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_powerful = yes
                        trigger_if = {
                            limit = {
                                is_governor = yes
                            }
                            corruption < 10 # Governors can't be highly corrupt or else provinces will lose loyalty
                        }
                        trigger_else = {
                            corruption < 40
                        }
                    }
                    # Highest character by power base
                    order_by = power_base
                    position = 0
                    # Don't print error if there is no such character
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    free_hands_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If couldn't fix anyone's loyalty at all, give stipends to eligible character with highest power base
            if = {
                limit = {
                    local_var:loyalty_fixes_done = 0
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        grant_stipends_potential_trigger = yes
                        grant_stipends_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_powerful = yes
                    }
                    # Highest character by power base
                    order_by = power_base
                    position = 0
                    # Don't print error if there is no such character
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    grant_stipends_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
        }

        # No urgency so fix loyalty more conservatively
        else = {

            # Bribe important disloyal eligible character with highest power base
            if = {
                limit = {
                    country_uses_persuation_instead_of_bribing = yes
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        orator_bribe_character_potential_trigger = yes
                        orator_bribe_character_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_important = yes
                    }
                    # Highest character by power base
                    order_by = power_base
                    position = 0
                    # Don't print error if there is no such character
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    orator_bribe_character = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
            else = {
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility for the interaction
                        bribe_character_potential_trigger = yes
                        bribe_character_allowed_trigger = yes
                        # Additional conditions we want to match
                        character_is_disloyal = yes
                        character_is_important = yes
                    }
                    # Highest character by power base
                    order_by = power_base
                    position = 0
                    # Don't print error if there is no such character
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    bribe_character_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If no bribing happened and we have some stored political influence
            if = {
                limit = {
                    local_var:loyalty_fixes_done = 0
                    political_influence >= 55 # Sacrifice + bribe price
                }

                # Bribe important close to disloyal eligible character with highest power base
                if = {
                    limit = {
                        country_uses_persuation_instead_of_bribing = yes
                    }
                    ordered_character = {
                        limit = {
                            # Required by character interaction triggers
                            save_temporary_scope_as = target
                            # Check eligibility for the interaction
                            orator_bribe_character_potential_trigger = yes
                            orator_bribe_character_allowed_trigger = yes
                            # Additional conditions we want to match
                            character_is_close_to_disloyal = yes
                            character_is_important = yes
                        }
                        # Highest character by power base
                        order_by = power_base
                        position = 0
                        # Don't print error if there is no such character
                        check_range_bounds = no
                        # Required by character interaction effects
                        save_scope_as = target
                        # Perform interaction
                        orator_bribe_character = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                        # Garbage collection
                        clear_saved_scope = target
                    }
                }
                else = {
                    ordered_character = {
                        limit = {
                            # Required by character interaction triggers
                            save_temporary_scope_as = target
                            # Check eligibility for the interaction
                            bribe_character_potential_trigger = yes
                            bribe_character_allowed_trigger = yes
                            # Additional conditions we want to match
                            character_is_close_to_disloyal = yes
                            character_is_important = yes
                        }
                        # Highest character by power base
                        order_by = power_base
                        position = 0
                        # Don't print error if there is no such character
                        check_range_bounds = no
                        # Required by character interaction effects
                        save_scope_as = target
                        # Perform interaction
                        bribe_character_effect = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                        # Garbage collection
                        clear_saved_scope = target
                    }
                }
            }
        }

        # Garbage collection
        clear_saved_scope = actor
        remove_local_variable = loyalty_fixes_done
    }
}

ai_revoke_free_hands = {
    if = {
        limit = {
            is_ai = yes
        }

        # Required by character interaction triggers and effects
        save_scope_as = actor

        every_character = {
            limit = {
                # Required by character interaction triggers
                save_temporary_scope_as = target
                # Check eligibility for the interaction
                tie_hands_potential_trigger = yes
                tie_hands_allowed_trigger = yes
                # Additional conditions we want to match
                OR = {
                    loyalty >= 70 # Should be enough to not go disloyal after this
                    trigger_if = {
                        limit = {
                            is_governor = yes
                        }
                        corruption >= 20 # Governors can't be highly corrupt or else provinces will lose loyalty
                    }
                    trigger_else = {
                        corruption >= 50
                    }
                }
            }
            # Required by character interaction effects
            save_scope_as = target
            # Perform interaction
            tie_hands_effect = yes
            # Garbage collection
            clear_saved_scope = target
        }
        
        # Garbage collection
        clear_saved_scope = actor
    }
}