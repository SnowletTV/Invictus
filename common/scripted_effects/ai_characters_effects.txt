ai_fix_character_loyalty = {
    if = {
        limit = {
            is_ai = yes
            exists = current_ruler
        }

        # Required by character interaction triggers and effects
        save_scope_as = actor

        # Track how much loyalty fixing we already performed
        set_local_variable = {
            name = loyalty_fixes_done
            value = 0
        }

        # Urgent need to fix loyalty
        if = {
            limit = {
                OR = {
                    towards_civil_war = yes
                    AND = {
                        is_tribal = yes
                        any_character = {
                            is_clan_chief = yes
                            loyalty <= 33
                        }
                    }
                }
            }

            # Bribe up to 3 disloyal eligible characters with high power base
            if = {
                limit = {
                    scope:actor.current_ruler = {
                        OR = {
                            has_trait = orator
                            has_trait = silver_tongued
                            has_trait = charming
                            has_trait = cultured
                        }
                    }
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Conditions to fix character loyalty
                        scope:actor = {
                            OR = {
                                towards_civil_war = yes
                                AND = {
                                    is_tribal = yes
                                    scope:target = {
                                        is_clan_chief = yes
                                    }
                                }
                            }
                        }
                        # Check eligibility
                        orator_bribe_character_potential_trigger = yes
                        orator_bribe_character_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33
                        relative_power_base >= 5.00
                    }
                    order_by = power_base
                    min = 0
                    max = 3
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    if = {
                        limit = {
                            # Re-check cause we are bribing multiple people so we could run out of PI and gold midway
                            orator_bribe_character_allowed_trigger = yes
                        }
                        orator_bribe_character = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
            else = {
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Conditions to fix character loyalty
                        scope:actor = {
                            OR = {
                                towards_civil_war = yes
                                AND = {
                                    is_tribal = yes
                                    scope:target = {
                                        is_clan_chief = yes
                                    }
                                }
                            }
                        }
                        # Check eligibility
                        bribe_character_potential_trigger = yes
                        bribe_character_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33
                        relative_power_base >= 5.00
                    }
                    order_by = power_base
                    min = 0
                    max = 3
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    if = {
                        limit = {
                            # Re-check cause we are bribing multiple people so we could run out of PI and gold midway
                            bribe_character_allowed_trigger = yes
                        }
                        bribe_character_effect = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If couldn't bribe 3 characters, give free hands to eligible character with highest power base
            if = {
                limit = {
                    local_var:loyalty_fixes_done < 3
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Conditions to fix character loyalty
                        scope:actor = {
                            OR = {
                                towards_civil_war = yes
                                AND = {
                                    is_tribal = yes
                                    scope:target = {
                                        is_clan_chief = yes
                                    }
                                }
                            }
                        }
                        # Check eligibility
                        free_hands_potential_trigger = yes
                        free_hands_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33
                        relative_power_base >= 5.00
                        trigger_if = {
                            limit = {
                                is_governor = yes
                            }
                            corruption < 10
                        }
                        trigger_else = {
                            corruption < 40
                        }
                    }
                    order_by = power_base
                    position = 0
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    free_hands_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If couldn't fix anyone's loyalty at all, give stipends to eligible character with highest power base
            if = {
                limit = {
                    local_var:loyalty_fixes_done = 0
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Conditions to fix character loyalty
                        scope:actor = {
                            OR = {
                                towards_civil_war = yes
                                AND = {
                                    is_tribal = yes
                                    scope:target = {
                                        is_clan_chief = yes
                                    }
                                }
                            }
                        }
                        # Check eligibility
                        grant_stipends_potential_trigger = yes
                        grant_stipends_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33
                        relative_power_base >= 5.00
                    }
                    order_by = power_base
                    position = 0
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    grant_stipends_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
        }

        # No urgency, fix loyalty more conservatively
        else = {
            # Bribe important disloyal eligible character with highest power base
            if = {
                limit = {
                    scope:actor.current_ruler = {
                        OR = {
                            has_trait = orator
                            has_trait = silver_tongued
                            has_trait = charming
                            has_trait = cultured
                        }
                    }
                }
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility
                        orator_bribe_character_potential_trigger = yes
                        orator_bribe_character_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33 # Disloyal
                        OR = {
                            has_any_office = yes
                            is_governor = yes
                            is_general = yes
                            is_admiral = yes
                            is_clan_chief = yes
                            relative_power_base >= 5.00
                        }
                    }
                    order_by = power_base
                    position = 0
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    orator_bribe_character = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }
            else = {
                ordered_character = {
                    limit = {
                        # Required by character interaction triggers
                        save_temporary_scope_as = target
                        # Check eligibility
                        bribe_character_potential_trigger = yes
                        bribe_character_allowed_trigger = yes
                        # Conditions we want to match
                        loyalty <= 33 # Disloyal
                        OR = {
                            has_any_office = yes
                            is_governor = yes
                            is_general = yes
                            is_admiral = yes
                            is_clan_chief = yes
                            relative_power_base >= 5.00
                        }
                    }
                    order_by = power_base
                    position = 0
                    check_range_bounds = no
                    # Required by character interaction effects
                    save_scope_as = target
                    # Perform interaction
                    bribe_character_effect = yes
                    change_local_variable = {
                        name = loyalty_fixes_done
                        add = 1
                    }
                    # Garbage collection
                    clear_saved_scope = target
                }
            }

            # If no bribing happened and we have some stored political influence
            if = {
                limit = {
                    local_var:loyalty_fixes_done = 0
                    political_influence >= 55 # Sacrifice + bribe price
                }
                # Bribe important close to disloyal eligible character with highest power base
                if = {
                    limit = {
                        scope:actor.current_ruler = {
                            OR = {
                                has_trait = orator
                                has_trait = silver_tongued
                                has_trait = charming
                                has_trait = cultured
                            }
                        }
                    }
                    ordered_character = {
                        limit = {
                            # Required by character interaction triggers
                            save_temporary_scope_as = target
                            # Check eligibility
                            orator_bribe_character_potential_trigger = yes
                            orator_bribe_character_allowed_trigger = yes
                            # Conditions we want to match
                            loyalty <= 38 # Disloyal + buffer of 5
                            OR = {
                                has_any_office = yes
                                is_governor = yes
                                is_general = yes
                                is_admiral = yes
                                is_clan_chief = yes
                                relative_power_base >= 5.00
                            }
                        }
                        order_by = power_base
                        position = 0
                        check_range_bounds = no
                        # Required by character interaction effects
                        save_scope_as = target
                        # Perform interaction
                        orator_bribe_character = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                        # Garbage collection
                        clear_saved_scope = target
                    }
                }
                else = {
                    ordered_character = {
                        limit = {
                            # Required by character interaction triggers
                            save_temporary_scope_as = target
                            # Check eligibility
                            bribe_character_potential_trigger = yes
                            bribe_character_allowed_trigger = yes
                            # Conditions we want to match
                            loyalty <= 38 # Disloyal + buffer of 5
                            OR = {
                                has_any_office = yes
                                is_governor = yes
                                is_general = yes
                                is_admiral = yes
                                is_clan_chief = yes
                                relative_power_base >= 5.00
                            }
                        }
                        order_by = power_base
                        position = 0
                        check_range_bounds = no
                        # Required by character interaction effects
                        save_scope_as = target
                        # Perform interaction
                        bribe_character_effect = yes
                        change_local_variable = {
                            name = loyalty_fixes_done
                            add = 1
                        }
                        # Garbage collection
                        clear_saved_scope = target
                    }
                }
            }
        }

        every_character = {
            limit = {
                # Required by character interaction triggers
                save_temporary_scope_as = target
                # Check eligibility
                tie_hands_potential_trigger = yes
                tie_hands_allowed_trigger = yes
                # Conditions we want to match
                OR = {
                    loyalty >= 70
                    trigger_if = {
                        limit = {
                            is_governor = yes
                        }
                        corruption >= 20
                    }
                    trigger_else = {
                        corruption >= 50
                    }
                }
            }
            # Required by character interaction effects
            save_scope_as = target
            # Perform interaction
            tie_hands_effect = yes
            # Garbage collection
            clear_saved_scope = target
        }

        # Garbage collection
        clear_saved_scope = actor
        remove_local_variable = loyalty_fixes_done
    }
}