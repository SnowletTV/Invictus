ai_choose_and_make_investment = {
    if = {
        limit = {
            is_ai = yes
            war = no
            OR = {
                political_influence >= 125 # Investment price + small buffer
                AND = {
                    has_variable = free_investments
                    var:free_investments > 0
                }
            }
        }

        # Save to variable cause we may want to use it more than once
        set_local_variable = {
            name = any_state_is_below_limit
            value = {
                if = {
                    limit = {
                        any_country_state = {
                            current_state_investments_plus_1 <= ai_investments_allowed_per_state
                        }
                    }
                    value = 1
                }
                else = {
                    value = 0
                }
            }
        }

        # Either there's a state below limit or we have free investments and we want to use them regardless
        if = {
            limit = {
                OR = {
                    local_var:any_state_is_below_limit = 1
                    AND = {
                        has_variable = free_investments
                        var:free_investments > 0
                    }
                }
            }

            # Uses the same triggers and effects as buttons, which requires scope:player to function
            save_scope_as = player

            # To check if we already made an investment, we don't wanna make more than 1 at the time
            set_local_variable = {
                name = made_investment
                value = 0
            }

            # Oratory investment in states dying of hunger
            random_country_state = {
                limit = {
                    # Either the state is under the limit, or there's no states under the limit
                    OR = {
                        local_var:any_state_is_below_limit = 0
                        current_state_investments_plus_1 <= ai_investments_allowed_per_state
                    }
                    # Validity conditions from the investment button
                    invest_in_state_button_is_valid = {
                        type = oratory
                    }
                    # You don't need more trade routes if you are not using existing ones
                    unused_trade_routes < 1
                    # Food is very low
                    has_state_food <= 50
                    # It's caused by city population
                    any_state_province = {
                        has_city_status = yes
                    }
                }
                weight = {
                    base = 1
                    modifier = {
                        factor = ai_state_importance
                    }
                }
                # Pressing effect from the investment button
                invest_in_state_button_effect = {
                    type = oratory
                }
                change_local_variable = {
                    name = made_investment
                    add = 1
                }
            }

            # Military investment
            if = {
                limit = {
                    local_var:made_investment = 0
                }
                random_country_state = {
                    limit = {
                        # Either the state is under the limit, or there's no states under the limit
                        OR = {
                            local_var:any_state_is_below_limit = 0
                            current_state_investments_plus_1 <= ai_investments_allowed_per_state
                        }
                        # Validity conditions from the investment button
                        invest_in_state_button_is_valid = {
                            type = military
                        }
                        # Only if overloaded on fort limit
                        state_fort_limit_used > state_fort_limit
                        NOT = {
                            has_state_modifier = state_improvement_military
                        }
                    }
                    weight = {
                        base = 1
                        modifier = {
                            factor = ai_state_importance
                        }
                    }
                    # Pressing effect from the investment button
                    invest_in_state_button_effect = {
                        type = military
                    }
                    change_local_variable = {
                        name = made_investment
                        add = 1
                    }
                }
            }

            # Sparta's unique DLC civic investment, this one is pretty OP
            if = {
                limit = {
                    local_var:made_investment = 0
                }
                # Must have DLC and be Sparta
                if = {
                    limit = {
                        trigger_if = {
                            limit = {
                                has_dlc = "Magna Graecia"
                            }
                            OR = {
                                tag = SPA
                                has_variable = spa_unique_mech
                            }
                        }
                        trigger_else = {
                            always = no
                        }
                    }
                    random_country_state = {
                        limit = {
                            # Either the state is under the limit, or there's no states under the limit
                            OR = {
                                local_var:any_state_is_below_limit = 0
                                current_state_investments_plus_1 <= ai_investments_allowed_per_state
                            }
                            # Validity conditions from the investment button
                            invest_in_state_button_is_valid = {
                                type = civic
                            }
                            # It's very good, get one trade investment and then spam this
                            has_state_modifier = state_improvement_oratory
                            any_state_province = {
                                has_city_status = yes
                            }
                        }
                        weight = {
                            base = 1
                            modifier = {
                                factor = ai_state_importance
                            }
                        }
                        # Pressing effect from the investment button
                        invest_in_state_button_effect = {
                            type = military_SPA
                        }
                        change_local_variable = {
                            name = made_investment
                            add = 1
                        }
                    }
                }
            }

            # Religious investment
            if = {
                limit = {
                    local_var:made_investment = 0
                }
                # Either no DLC, or not Sparta
                if = {
                    limit = {
                        trigger_if = {
                            limit = {
                                has_dlc = "Magna Graecia"
                            }
                            NOR = {
                                tag = SPA
                                has_variable = spa_unique_mech
                            }
                        }
                        trigger_else = {
                            always = yes
                        }
                    }
                    random_country_state = {
                        limit = {
                            # Either the state is under the limit, or there's no states under the limit
                            OR = {
                                local_var:any_state_is_below_limit = 0
                                current_state_investments_plus_1 <= ai_investments_allowed_per_state
                            }
                            # Validity conditions from the investment button
                            invest_in_state_button_is_valid = {
                                type = religious
                            }
                            # Only if has multiple cities almost full on building slots
                            any_state_province = {
                                count >= 2
                                has_city_status = yes
                                free_building_slots <= 1
                            }
                        }
                        weight = {
                            base = 1
                            modifier = {
                                factor = ai_state_importance
                            }
                        }
                        # Pressing effect from the investment button
                        invest_in_state_button_effect = {
                            type = religious
                        }
                        change_local_variable = {
                            name = made_investment
                            add = 1
                        }
                    }
                }
            }

            # Civic investment
            if = {
                limit = {
                    local_var:made_investment = 0
                }
                # Either no DLC, or not Sparta
                if = {
                    limit = {
                        trigger_if = {
                            limit = {
                                has_dlc = "Magna Graecia"
                            }
                            NOR = {
                                tag = SPA
                                has_variable = spa_unique_mech
                            }
                        }
                        trigger_else = {
                            always = yes
                        }
                    }
                    random_country_state = {
                        limit = {
                            # Either the state is under the limit, or there's no states under the limit
                            OR = {
                                local_var:any_state_is_below_limit = 0
                                current_state_investments_plus_1 <= ai_investments_allowed_per_state
                            }
                            # Validity conditions from the investment button
                            invest_in_state_button_is_valid = {
                                type = civic
                            }
                            # Only if >=50% of territories is close to population limit
                            any_state_province = {
                                percent >= 0.50
                                total_population >= 90_percent_of_population_cap
                            }
                        }
                        weight = {
                            base = 1
                            modifier = {
                                factor = ai_state_importance
                            }
                        }
                        # Pressing effect from the investment button
                        invest_in_state_button_effect = {
                            type = civic
                        }
                        change_local_variable = {
                            name = made_investment
                            add = 1
                        }
                    }
                }
            }

            # Oratory investment
            if = {
                limit = {
                    local_var:made_investment = 0
                }
                random_country_state = {
                    limit = {
                        # Either the state is under the limit, or there's no states under the limit
                        OR = {
                            local_var:any_state_is_below_limit = 0
                            current_state_investments_plus_1 <= ai_investments_allowed_per_state
                        }
                        # Validity conditions from the investment button
                        invest_in_state_button_is_valid = {
                            type = oratory
                        }
                        # You don't need more trade routes if you are not using existing ones
                        unused_trade_routes < 1
                    }
                    weight = {
                        base = 1
                        modifier = {
                            factor = ai_state_importance
                        }
                    }
                    # Pressing effect from the investment button
                    invest_in_state_button_effect = {
                        type = oratory
                    }
                    change_local_variable = {
                        name = made_investment
                        add = 1
                    }
                }
            }

            # Sparta's unique DLC religious investment, not as useful so use only as fallback
            if = {
                limit = {
                    # Actually it's better to just keep resources and limits for future opportunities
                    always = no
                    local_var:made_investment = 0
                }
                # Must have DLC and be Sparta
                if = {
                    limit = {
                        trigger_if = {
                            limit = {
                                has_dlc = "Magna Graecia"
                            }
                            OR = {
                                tag = SPA
                                has_variable = spa_unique_mech
                            }
                        }
                        trigger_else = {
                            always = no
                        }
                    }
                    random_country_state = {
                        limit = {
                            # Either the state is under the limit, or there's no states under the limit
                            OR = {
                                local_var:any_state_is_below_limit = 0
                                current_state_investments_plus_1 <= ai_investments_allowed_per_state
                            }
                            # Validity conditions from the investment button
                            invest_in_state_button_is_valid = {
                                type = religious
                            }
                        }
                        weight = {
                            base = 1
                            modifier = {
                                factor = ai_state_importance
                            }
                        }
                        # Pressing effect from the investment button
                        invest_in_state_button_effect = {
                            type = religious_SPA
                        }
                        change_local_variable = {
                            name = made_investment
                            add = 1
                        }
                    }
                }
            }

            # Garbage collection
            clear_saved_scope = player
            remove_local_variable = made_investment
        }

        # Garbage collection
        remove_local_variable = any_state_is_below_limit
    }
}