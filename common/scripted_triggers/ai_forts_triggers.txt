territory_is_ownable = {
    # Hard to oversell how much faster this is compared to the other way
    trigger_if = {
        limit = {
            has_non_empty_global_variable_list = {
                name = ownable_territories
            }
        }
        is_target_in_global_variable_list = {
            name = ownable_territories
            target = this
        }
    }
    trigger_else = {
        any_ownable_province = {
            this = prev
        }
    }
}

# Don't check building slots and other stuff here because it's used as building allow so it's all checked externally
ai_allowed_to_build_fort_in_territory = {
    # Allow to build in territories other than capital state redoubt only if it has fort
    trigger_if = {
        limit = {
            owner = {
                capital_scope.state = {
                    ai_state_redoubt_has_fort_or_can_not = no
                }
            }
        }
        state = {
            is_capital_state = yes
        }
        ai_territory_is_redoubt_of_state = yes
    }
    trigger_else = {
        # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
        state = {
            cache_redoubt_of_state_for_trigger = yes
        }

        # Allow to build in territories other than state redoubt only if it has fort
        trigger_if = {
            limit = {
                state = {
                    ai_state_redoubt_has_fort_or_can_not = no
                }
            }
            ai_territory_is_redoubt_of_state = yes
        }
        trigger_else = {
            always = yes
        }

        # Territory hasn't reached its target for num of forts
        trigger_if = {
            limit = {
                ai_fort_level_is_lower_than_wanted = yes
            }
            # Building more than level 1 is allowed only in capital redoubt or if all perimeter states have forts
            trigger_if = {
                limit = {
                    OR = {
                        num_of_fortress_building_projected < 1
                        AND = {
                            state = {
                                is_capital_state = yes
                            }
                            ai_territory_is_redoubt_of_state = yes
                        }
                    }
                }
                always = yes
            }
            trigger_else = {
                owner = {
                    all_perimeter_states_have_redoubt_fort = yes
                }
            }

            # Building outside of redoubts is allowed only if all redoubt high tier forts are built
            trigger_if = {
                limit = {
                    ai_territory_is_redoubt_of_state = yes
                }
                always = yes
            }
            trigger_else = {
                owner = {
                    # Overwrites state redoubt cache, so should be last in order
                    all_redoubt_high_tier_forts_are_built = yes
                }
            }
        }
        trigger_else = {
            always = no
        }
    }
}

ai_wants_giga_fort_in_territory = {
    is_capital = yes
}

ai_wants_mega_fort_in_territory = {
    # Only build mega forts in capital state and on perimeter as they are a huge budget drain
    trigger_if = {
        limit = {
            exists = state
            state = {
                OR = {
                    is_capital_state = yes
                    state_is_perimeter_of_its_country = yes
                }
            }
        }
        # Only build mega forts in redoubts with high fort importance, otherwise it's not worth the investment
        territory_priority_for_having_fort >= priority_threshold_for_mega_fort
        ai_territory_is_redoubt_of_state = yes
    }
    trigger_else = {
        always = no
    }
}

ai_wants_single_fort_in_territory = {
    # Build forts in capital state and all perimeter ones to defend country border
    trigger_if = {
        limit = {
            exists = state
            state = {
                OR = {
                    is_capital_state = yes
                    state_is_perimeter_of_its_country = yes
                }
            }
        }
        # Either redoubt, or outwork with high fort importance
        OR = {
            ai_territory_is_redoubt_of_state = yes
            AND = {
                territory_priority_for_having_fort >= priority_threshold_for_single_fort
                ai_territory_is_outwork_of_state = yes
            }
        }
    }
    trigger_else = {
        # For non-perimeter states it must be redoubt with high fort importance
        territory_priority_for_having_fort >= priority_threshold_for_single_fort
        ai_territory_is_redoubt_of_state = yes
    }

    # Reserve fort limit for redoubt it it wants mega or giga fort
    trigger_if = {
        limit = {
            ai_territory_is_redoubt_of_state = no
            ai_state_redoubt_wants_high_tier_fort = yes
        }
        state.state_fort_limit_svalue >= fort_limit_for_mega_and_single_forts
    }
    trigger_else = {
        always = yes
    }
}

ai_wants_high_tier_fort_in_territory = {
    # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
    state = {
        cache_redoubt_of_state_for_trigger = yes
    }

    OR = {
        ai_wants_giga_fort_in_territory = yes
        ai_wants_mega_fort_in_territory = yes
    }
}

ai_state_redoubt_wants_high_tier_fort = {
    # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
    state = {
        cache_redoubt_of_state_for_trigger = yes
    }

    scope:cached_redoubt_of_state_for_trigger = {
        ai_wants_high_tier_fort_in_territory = yes
    }
}

ai_fort_level_is_higher_than_wanted = {
    # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
    state = {
        cache_redoubt_of_state_for_trigger = yes
    }

    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        num_of_fortress_building_projected > level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        num_of_fortress_building_projected > level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        num_of_fortress_building_projected > 1
    }
    trigger_else = {
        num_of_fortress_building_projected > 0
    }
}

ai_fort_level_is_lower_than_wanted = {
    # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
    state = {
        cache_redoubt_of_state_for_trigger = yes
    }

    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        num_of_fortress_building_projected < level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        num_of_fortress_building_projected < level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        num_of_fortress_building_projected < 1
    }
    trigger_else = {
        always = no
    }
}

ai_has_enough_building_slots_for_fort = {
    # Cache redoubt to make ai_territory_is_redoubt_of_state just a fast scope comparison
    state = {
        cache_redoubt_of_state_for_trigger = yes
    }
    
    # We count mega forts same as giga here for simplicity and giga being more of an extra than necessity
    trigger_if = {
        limit = {
            ai_wants_high_tier_fort_in_territory = yes
        }
        trigger_if = {
            limit = {
                $and_some_more$ = 1
            }
            free_building_slots > building_slots_required_for_mega_fort
        }
        trigger_else = {
            free_building_slots >= building_slots_required_for_mega_fort
        }
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        trigger_if = {
            limit = {
                $and_some_more$ = 1
            }
            free_building_slots > building_slots_required_for_single_fort
        }
        trigger_else = {
            free_building_slots >= building_slots_required_for_single_fort
        }
    }
    trigger_else = {
        always = yes
    }
}

ai_territory_can_have_fort = {
    # Ensure nothing weird happened and there are any slots at all
    num_of_total_building_slots > 0
    OR = {
        # If it has fort already, it probably can have it?
        num_of_fortress_building_projected > 0
        # Ports are not occupying all building slots - they are higher in priority
        can_have_port = no
        port_level_including_construction < num_of_total_building_slots
    }
}

# If it's already cached and it's of the same state, it does nothing, so it's safe to spam it in the same trigger chain
cache_redoubt_of_state_for_trigger = {
    OR = {
        trigger_if = {
            limit = {
                OR = {
                    NOT = {
                        exists = scope:cached_redoubt_of_state_for_trigger
                    }
                    NOT = {
                        this = scope:cached_redoubt_of_state_for_trigger.state
                    }
                }
            }
            # Check state capital first for performance as usually redoubt is there
            trigger_if = {
                limit = {
                    capital_scope = {
                        ai_territory_is_redoubt_of_state = yes
                    }
                }
                capital_scope = {
                    save_temporary_scope_as = cached_redoubt_of_state_for_trigger
                }
            }
            # Check all state territories to find redoubt
            trigger_else = {
                any_state_province = {
                    ai_territory_is_redoubt_of_state = yes
                    save_temporary_scope_as = cached_redoubt_of_state_for_trigger
                }
            }
        }
        always = yes
    }
}

ai_territory_is_redoubt_of_state = {
    trigger_if = {
        limit = {
            exists = scope:cached_redoubt_of_state_for_trigger
            state = scope:cached_redoubt_of_state_for_trigger.state
        }
        this = scope:cached_redoubt_of_state_for_trigger
    }
    trigger_else_if = {
        limit = {
            state = {
                OR = {
                    capital_scope = {
                        ai_territory_can_have_fort = yes
                    }
                    NOT = {
                        any_state_province = {
                            is_state_capital = no
                            ai_territory_can_have_fort = yes
                        }
                    }
                }
            }
        }
        is_state_capital = yes
    }
    trigger_else = {
        is_state_capital = no
        ai_territory_can_have_fort = yes
        save_temporary_scope_as = potential_redoubt_territory
        NOT = {
            state = {
                any_state_province = {
                    NOT = {
                        this = scope:potential_redoubt_territory
                    }
                    is_state_capital = no
                    ai_territory_can_have_fort = yes
                    territory_priority_for_state_redoubt > scope:potential_redoubt_territory.territory_priority_for_state_redoubt
                }
            }
        }
    }
}

ai_territory_is_outwork_of_state = {
    # State capital is always redoubt if it can have fort
    is_state_capital = no
    ai_territory_can_have_fort = yes

    save_temporary_scope_as = potential_outwork_territory

    # If state capital is redoubt, non-capital territory with highest outwork priority becomes outwork
    trigger_if = {
        limit = {
            state.capital_scope = {
                ai_territory_is_redoubt_of_state = yes
            }
        }
        NOT = {
            state = {
                any_state_province = {
                    NOT = {
                        this = scope:potential_outwork_territory
                    }
                    is_state_capital = no
                    ai_territory_can_have_fort = yes
                    territory_priority_for_state_outwork > scope:potential_outwork_territory.territory_priority_for_state_outwork
                }
            }
        }
    }

    # Otherwise non-capital territory with second highest outwork priority becomes outwork
    trigger_else = {
        state = {
            any_state_province = {
                # There's specifically 1 territory with higher priority, which becomes redoubt
                count = 1
                NOT = {
                    this = scope:potential_outwork_territory
                }
                is_state_capital = no
                ai_territory_can_have_fort = yes
                territory_priority_for_state_outwork > scope:potential_outwork_territory.territory_priority_for_state_outwork
            }
        }
    }
}

ai_state_redoubt_has_fort_or_can_not = {
    trigger_if = {
        limit = {
            exists = scope:cached_redoubt_of_state_for_trigger
            this = scope:cached_redoubt_of_state_for_trigger.state
        }
        scope:cached_redoubt_of_state_for_trigger = {
            OR = {
                num_of_fortress_building_projected > 0
                ai_territory_can_have_fort = no
            }
        }
    }
    # Check state capital first because usually redoubt is there
    trigger_else_if = {
        limit = {
            capital_scope = {
                ai_territory_is_redoubt_of_state = yes
            }
        }
        capital_scope = {
            OR = {
                num_of_fortress_building_projected > 0
                ai_territory_can_have_fort = no
            }
        }
    }
    # Otherwise loop through all state province if it's not capital
    trigger_else = {
        any_state_province = {
            is_state_capital = no
            OR = {
                num_of_fortress_building_projected > 0
                ai_territory_can_have_fort = no
            }
            ai_territory_is_redoubt_of_state = yes
        }
    }
}

# ai_state_outwork_has_fort_or_can_not = {
#     any_state_province = {
#         is_state_capital = no
#         OR = {
#             num_of_fortress_building_projected > 0
#             ai_territory_can_have_fort = no
#         }
#         ai_territory_is_outwork_of_state = yes
#     }
# }

state_is_perimeter_of_its_country = {
    owner = {
        has_non_empty_variable_list = {
            name = country_perimeter_states
        }
        is_target_in_variable_list = {
            name = country_perimeter_states
            target = prev
        }
    }
}

all_perimeter_states_have_redoubt_fort = {
    has_non_empty_variable_list = {
        name = country_perimeter_states
    }
    NOT = {
        any_in_list = {
            variable = country_perimeter_states
            ai_state_redoubt_has_fort_or_can_not = no
        }
    }
}

all_perimeter_states_have_any_forts = {
    trigger_if = {
        limit = {
            has_local_variable = all_perimeter_states_have_any_forts
        }
        local_var:all_perimeter_states_have_any_forts = 1
    }
    trigger_else = {
        has_non_empty_variable_list = {
            name = country_perimeter_states
        }
        NOT = {
            any_in_list = {
                variable = country_perimeter_states
                NOT = {
                    any_state_province = {
                        num_of_fortress_building_projected > 0
                    }
                }
            }
        }
    }
}

all_redoubt_high_tier_forts_are_built = {
    NOR = {
        capital_scope.state = {
            any_state_province = {
                ai_wants_high_tier_fort_in_territory = yes
                ai_territory_is_redoubt_of_state = yes
                num_of_fortress_building_projected < level_of_mega_fort_wanted
            }
        }
        AND = {
            has_non_empty_variable_list = {
                name = country_perimeter_states
            }
            any_in_list = {
                variable = country_perimeter_states
                any_state_province = {
                    ai_wants_high_tier_fort_in_territory = yes
                    ai_territory_is_redoubt_of_state = yes
                    num_of_fortress_building_projected < level_of_mega_fort_wanted
                }
            }
        }
    }
}

# This and ai_can_rebuild_fort_to_territory can't be true simultaneously for a given territory, incl with 1 less fort
ai_should_reduce_territory_fort = {
    OR = {
        # Territory has more fort levels that we want it to have
        ai_fort_level_is_higher_than_wanted = yes
        AND = {
            # Only do this sort of optimization if basic country defense is set up
            owner = {
                all_perimeter_states_have_any_forts = yes
            }
            # This is non-redoubt territory with fort, while redoubt doesn't have it
            num_of_fortress_building_projected > 0
            ai_territory_is_redoubt_of_state = no
            state = {
                ai_state_redoubt_has_fort_or_can_not = no
            }
        }
    }
}

# This and ai_should_reduce_territory_fort can't be true simultaneously for a given territory, incl with 1 less fort
# Requires local_var:all_perimeter_states_have_any_forts to be set for performance
ai_can_rebuild_fort_to_territory = {
    # There's no fort yet and there are free slots to build it
    free_building_slots > 0
    num_of_fortress_building_projected < 1
    # Check regular trigger for allowing to build fort in territory
    ai_allowed_to_build_fort_in_territory = yes
    # We won't exceed state fort limit by building it here
    state.state_fort_limit_svalue >= state_fort_limit_with_1_more_level
    # Only rebuild in redoubt territories, unless basic country defense is set up and state redoubt territory has fort
    OR = {
        ai_territory_is_redoubt_of_state = yes
        AND = {
            owner = {
                all_perimeter_states_have_any_forts = yes
            }
            state = {
                ai_state_redoubt_has_fort_or_can_not = yes
            }
        }
    }
}

# Covers gates, mountain passes, their desert alternatives, and probably various modifiers from missions etc.
ai_territory_is_deadly_to_armies = {
    OR = {
        modifier:attrition > 0
        modifier:local_hostile_attrition > 0
    }
    OR = {
        modifier:supply_limit < 0
        modifier:supply_limit_modifier < 0
        modifier:local_combat_width_modifier < 0
    }
}

ai_territory_is_good_for_defense = {
    OR = {
        ai_territory_is_deadly_to_armies = yes
        AND = {
            save_temporary_scope_as = potential_defense_territory
            any_neighbor_province = {
                ai_territory_is_deadly_to_armies = yes
                territory_is_ownable = no
                NOT = {
                    any_neighbor_province = {
                        NOT = {
                            this = scope:potential_defense_territory
                        }
                        owner = scope:potential_defense_territory.owner
                        territory_priority_by_population > scope:potential_defense_territory.territory_priority_by_population
                    }
                }
            }
        }
    }
}