state_is_border = {
    owner = {
        has_non_empty_variable_list = {
            name = country_border_states
        }
        is_target_in_variable_list = {
            name = country_border_states
            target = prev
        }
    }
}

all_border_states_have_forts = {
    has_non_empty_variable_list = {
        name = country_border_states
    }
    NOT = {
        any_in_list = {
            variable = country_border_states
            NOT = {
                any_state_province = {
                    fort_level_including_construction > 0
                }
            }
        }
    }
}

ai_can_build_fortress_building = {
    OR = {
        AND = {
            ai_wants_giga_fort_in_territory = yes
            fort_level_including_construction < level_of_giga_fort_wanted
        }
        AND = {
            ai_wants_mega_fort_in_territory = yes
            fort_level_including_construction < level_of_mega_fort_wanted
        }
        AND = {
            ai_wants_single_fort_in_territory = yes
            fort_level_including_construction < 1
        }
    }
    OR = {
        is_capital = yes
        fort_level_including_construction < 1
        owner = {
            all_border_states_have_forts = yes
        }
    }
    OR = {
        AND = {
            is_capital = yes
            fort_level_including_construction < 1
        }
        state.state_fort_limit_svalue >= state_fort_limit_with_1_more_level
    }
}

ai_wants_giga_fort_in_territory = {
    is_capital = yes
}

ai_wants_mega_fort_in_territory = {
    exists = state
    state = {
        state_is_border = yes
    }
    OR = {
        # Chokepoint, as in Mountain Pass
        AND = {
            has_province_modifier = lesser_pass_modifier
            OR = {
                is_state_capital = yes
                has_city_status = yes
            }
        }

        AND = {
            has_city_status = yes
            total_population >= 60
        }
    }

    # In capital state reserve at least 5 of fort limit for capital territory to have at least lvl 3 fort
    OR = {
        state = {
            is_capital_state = no
        }
        is_capital = yes
        state.state_fort_limit_svalue >= 10
    }
}

ai_wants_single_fort_in_territory = {
    OR = {
        AND = {
            exists = state
            state = {
                state_is_border = yes
            }
            OR = {

                # Only allow territories other than state capitals if it can't have a fort
                trigger_if = {
                    limit = {
                        state.capital_scope = {
                            ai_territory_can_have_fort = no
                        }
                    }
                    # If there are other territories having fort already, go for highest priority one
                    trigger_if = {
                        limit = {
                            state = {
                                any_state_province = {
                                    fort_level_including_construction > 0
                                }
                            }
                        }
                        fort_level_including_construction > 0
                        # Territory must be highest in priority for potentially becoming state capital
                        save_temporary_scope_as = evaluated_territory
                        NOT = {
                            state = {
                                any_state_province = {
                                    NOT = {
                                        this = scope:evaluated_territory
                                    }
                                    is_state_capital = no
                                    fort_level_including_construction > 0
                                    territory_priority_for_state_capital > scope:evaluated_territory.territory_priority_for_state_capital
                                }
                            }
                        }
                    }
                    # If there are no forts in state, choose highest priority territory that can have it
                    trigger_else = {
                        ai_territory_can_have_fort = yes
                        # Territory must be highest in priority for potentially becoming state capital
                        save_temporary_scope_as = evaluated_territory
                        NOT = {
                            state = {
                                any_state_province = {
                                    NOT = {
                                        this = scope:evaluated_territory
                                    }
                                    is_state_capital = no
                                    ai_territory_can_have_fort = yes
                                    territory_priority_for_state_capital > scope:evaluated_territory.territory_priority_for_state_capital
                                }
                            }
                        }
                    }
                }
                trigger_else = {
                    is_state_capital = yes
                }

                has_province_modifier = lesser_pass_modifier

                AND = {
                    has_city_status = yes
                    total_population >= 40
                }
            }
        }

        AND = {
            has_city_status = yes
            total_population >= 60
        }
    }

    # In capital state reserve at least 5 of fort limit for capital territory to have at least lvl 3 fort
    OR = {
        state = {
            is_capital_state = no
        }
        is_capital = yes
        state.state_fort_limit_svalue >= 8
    }
}

ai_territory_can_have_fort = {
    # Ensure nothing weird happened and there are any slots at all
    num_of_total_building_slots > 0
    OR = {
        # If it has fort already, it probably can have it?
        fort_level_including_construction > 0
        # Ports are not occupying all building slots - they are higher in priority
        can_have_port = no
        port_level_including_construction < num_of_total_building_slots
    }
}

ai_fort_level_is_higher_than_wanted = {
    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        fort_level_including_construction > level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        fort_level_including_construction > level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        fort_level_including_construction > 1
    }
    trigger_else = {
        fort_level_including_construction > 0
    }
}

ai_fort_level_is_lower_than_wanted = {
    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        fort_level_including_construction < level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        fort_level_including_construction < level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        fort_level_including_construction < 1
    }
    trigger_else = {
        always = no
    }
}

ai_can_rebuild_fort_to_territory = {
    free_building_slots > 0
    fort_level_including_construction < 1
    ai_fort_level_is_lower_than_wanted = yes
    state.state_fort_limit_svalue >= state_fort_limit_with_1_more_level
}