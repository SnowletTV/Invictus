territory_is_ownable = {
    # Hard to oversell how much faster this is compared to the other way
    trigger_if = {
        limit = {
            has_non_empty_global_variable_list = {
                name = ownable_territories
            }
        }
        is_target_in_global_variable_list = {
            name = ownable_territories
            target = this
        }
    }
    trigger_else = {
        any_ownable_province = {
            this = prev
        }
    }
}

state_is_perimeter_of_its_country = {
    owner = {
        has_non_empty_variable_list = {
            name = country_perimeter_states
        }
        is_target_in_variable_list = {
            name = country_perimeter_states
            target = prev
        }
    }
}

perimeter_states_have_capital_fort = {
    has_non_empty_variable_list = {
        name = country_perimeter_states
    }
    NOT = {
        any_in_list = {
            variable = country_perimeter_states
            capital_scope = {
                num_of_fortress_building_projected <= 0
                ai_territory_can_have_fort = yes
            }
        }
    }
}

ai_allowed_to_build_fort_in_territory = {
    # Allow to build in territories other than country capital only if it has fort or cannot have it
    OR = {
        is_capital = yes
        owner.capital_scope = {
            OR = {
                num_of_fortress_building_projected > 0
                ai_territory_can_have_fort = no
            }
        }
    }

    # Allow to build in territories other than state capital only if it has fort or cannot have it
    OR = {
        is_state_capital = yes
        state.capital_scope = {
            OR = {
                num_of_fortress_building_projected > 0
                ai_territory_can_have_fort = no
            }
        }
    }

    # Territory hasn't reached its target for num of forts
    ai_fort_level_is_lower_than_wanted = yes

    # Building more than level 1 is allowed only in country capital or if all perimeter states have forts
    OR = {
        num_of_fortress_building_projected < 1
        is_capital = yes
        owner = {
            perimeter_states_have_capital_fort = yes
        }
    }
}

ai_wants_giga_fort_in_territory = {
    is_capital = yes
}

ai_wants_mega_fort_in_territory = {
    # In capital state reserve at least 5 of fort limit for capital territory to have at least lvl 3 fort
    OR = {
        state = {
            is_capital_state = no
        }
        is_capital = yes
        state.state_fort_limit_svalue >= 10
    }

    # Only build mega forts on perimeter as they are a huge budget drain
    exists = state
    state = {
        state_is_perimeter_of_its_country = yes
    }

    OR = {
        # A highly populated state capital city
        AND = {
            is_state_capital = yes
            has_city_status = yes
            total_population >= 60
        }

        # State capital or just decently populated city that makes a good fort
        ai_territory_is_good_for_defense = {
            mega = 1
        }
    }
}

ai_wants_single_fort_in_territory = {
    # In capital state reserve at least 5 of fort limit for capital territory to have at least lvl 3 fort
    OR = {
        state = {
            is_capital_state = no
        }
        is_capital = yes
        state.state_fort_limit_svalue >= 8
    }

    trigger_if = {
        limit = {
            exists = state
            state = {
                state_is_perimeter_of_its_country = yes
            }
        }
        OR = {
            # A decently populated city
            AND = {
                has_city_status = yes
                total_population >= 40
            }

            # Makes a good fort due to map setup reasons
            ai_territory_is_good_for_defense = {
                mega = 0
            }

            # Capital of every perimeter state
            trigger_if = {
                limit = {
                    state.capital_scope = {
                        ai_territory_can_have_fort = yes
                    }
                }
                is_state_capital = yes
            }
            # Only allow territories other than state capitals if it can't have a fort
            trigger_else = {
                
                # If there are any state territories that want a fort due to other conditions, go for them
                trigger_if = {
                    limit = {
                        state = {
                            any_state_province = {
                                is_state_capital = no
                                ai_territory_can_have_fort = yes

                                OR = {
                                    # A decently populated city
                                    AND = {
                                        has_city_status = yes
                                        total_population >= 40
                                    }

                                    # Makes a good fort due to map setup reasons
                                    ai_territory_is_good_for_defense = {
                                        mega = 0
                                    }
                                }
                            }
                        }
                    }
                    always = no
                }

                # If there are other territories having fort already, go for highest priority one
                trigger_else_if = {
                    limit = {
                        state = {
                            any_state_province = {
                                num_of_fortress_building_projected > 0
                            }
                        }
                    }
                    num_of_fortress_building_projected > 0
                    # Territory must be highest in priority for potentially becoming state capital
                    save_temporary_scope_as = evaluated_territory
                    NOT = {
                        state = {
                            any_state_province = {
                                NOT = {
                                    this = scope:evaluated_territory
                                }
                                is_state_capital = no
                                num_of_fortress_building_projected > 0
                                territory_priority_for_state_capital > scope:evaluated_territory.territory_priority_for_state_capital
                            }
                        }
                    }
                }

                # If there are no forts in state, choose highest priority territory that can have it
                trigger_else = {
                    ai_territory_can_have_fort = yes
                    # Territory must be highest in priority for potentially becoming state capital
                    save_temporary_scope_as = evaluated_territory
                    NOT = {
                        state = {
                            any_state_province = {
                                NOT = {
                                    this = scope:evaluated_territory
                                }
                                is_state_capital = no
                                ai_territory_can_have_fort = yes
                                territory_priority_for_state_capital > scope:evaluated_territory.territory_priority_for_state_capital
                            }
                        }
                    }
                }
            }
        }
    }
    trigger_else = {
        
        # A decently populated state capital city
        AND = {
            is_state_capital = yes
            has_city_status = yes
            total_population >= 40
        }
    }
}

ai_territory_can_have_fort = {
    # Ensure nothing weird happened and there are any slots at all
    num_of_total_building_slots > 0
    OR = {
        # If it has fort already, it probably can have it?
        num_of_fortress_building_projected > 0
        # Ports are not occupying all building slots - they are higher in priority
        can_have_port = no
        port_level_including_construction < num_of_total_building_slots
    }
}

ai_fort_level_is_higher_than_wanted = {
    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        num_of_fortress_building_projected > level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        num_of_fortress_building_projected > level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        num_of_fortress_building_projected > 1
    }
    trigger_else = {
        num_of_fortress_building_projected > 0
    }
}

ai_fort_level_is_lower_than_wanted = {
    trigger_if = {
        limit = {
            ai_wants_giga_fort_in_territory = yes
        }
        num_of_fortress_building_projected < level_of_giga_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_mega_fort_in_territory = yes
        }
        num_of_fortress_building_projected < level_of_mega_fort_wanted
    }
    trigger_else_if = {
        limit = {
            ai_wants_single_fort_in_territory = yes
        }
        num_of_fortress_building_projected < 1
    }
    trigger_else = {
        always = no
    }
}

ai_can_rebuild_fort_to_territory = {
    free_building_slots > 0
    num_of_fortress_building_projected < 1
    ai_fort_level_is_lower_than_wanted = yes
    state.state_fort_limit_svalue >= state_fort_limit_with_1_more_level
}

# Covers gates, mountain passes, their desert alternatives, and probably various modifiers from missions etc.
ai_territory_is_deadly_to_armies = {
    OR = {
        modifier:attrition > 0
        modifier:local_hostile_attrition > 0
    }
    OR = {
        modifier:supply_limit < 0
        modifier:supply_limit_modifier < 0
        modifier:local_combat_width_modifier < 0
    }
}

ai_territory_is_good_for_defense = {
    OR = {
        $mega$ = 0
        is_state_capital = yes
        AND = {
            has_city_status = yes
            total_population >= 30
        }
    }
    OR = {
        ai_territory_is_deadly_to_armies = yes
        AND = {
            save_temporary_scope_as = evaluated_mega_fort_territory
            any_neighbor_province = {
                ai_territory_is_deadly_to_armies = yes
                territory_is_ownable = no
                NOT = {
                    any_neighbor_province = {
                        NOT = {
                            this = scope:evaluated_mega_fort_territory
                        }
                        owner = scope:evaluated_mega_fort_territory.owner
                        OR = {
                            $mega$ = 0
                            is_state_capital = yes
                            AND = {
                                has_city_status = yes
                                total_population >= 30
                            }
                        }
                        territory_priority_by_id > scope:evaluated_mega_fort_territory.territory_priority_by_id
                    }
                }
            }
        }
    }
}