namespace = kleonymos_korkyra_event

kleonymos_korkyra_event.1 = { #Kleonymos in Korkyra
    type = country_event
    title = kleonymos_korkyra_event.1.t
    desc = kleonymos_korkyra_event.1.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = grand_ship
    goto_location = 470

    immediate = {
        hidden_effect = {
            p:470.owner = {
                if = {
                    limit = { is_subject = yes }
                    overlord = { save_scope_as = korkyra_defender }
                }
                else = {
                    save_scope_as = korkyra_defender
                    save_scope_as = korkyra_owner
                }   
            }
        }
    }
    option = {
        name = kleonymos_korkyra_event.1.a
        custom_tooltip = "kleonymos_korkyra_event.1_tt"        
        scope:korkyra_defender = {
            trigger_event = {
                id = kleonymos_korkyra_event.2
            }
        }
    }
}

kleonymos_korkyra_event.2 = { #spartan invasion
    type = country_event
    title = kleonymos_korkyra_event.2.t
    desc = kleonymos_korkyra_event.2.desc 
    left_portrait = current_ruler
    right_portrait = char:176
    picture = greeks_marching
    trigger = {
        char:176 = {
            is_alive = yes
            is_ruler = no
        }
    }
    immediate = {
        hidden_effect = {
            char:176 = {
                move_country_with_close_family_effect = { 
                    COUNTRY = c:BAR 
                }  
            }
            c:BAR = {
                create_unit = {
                    navy = no
                    location = p:470
                    name = "Kleonymos' Army"
                    commander = char:176
                    while = {
                        count = 6
                        add_subunit = spearmen 
                    }
                    while = {
                        count = 10
                        add_subunit = light_infantry 
                    }
                    while = {
                        count = 2
                        add_subunit = supply_train 
                    }
                }
            }
        }
    }
    option = {
        name = kleonymos_korkyra_event.2.a
        trigger_event = {
            id = kleonymos_korkyra_event.9
            days = 365 #one year
        }
        custom_tooltip = "kleonymos_korkyra_event.2_tt"
    }
}

kleonymos_korkyra_event.9 = { #check if Kleonymos controls patavium
    type = country_event
    hidden = yes

    immediate = {
        if = {
            limit = {
                p:470 = {
                    OR = {
                        controller = scope:korkyra_defender
                        controller = scope:korkyra_owner
                    }  
                }
            }
            trigger_event = {#defeat
                id = kleonymos_korkyra_event.3
            }
        }
        if = {
            limit = {
                OR = {
                    p:470 = {
                        controller = c:BAR
                    }
                    char:176 = {
                        OR = {
                            is_at_location = p:470
                        }
                    }
                }
            }
            trigger_event = {#Victory
                id = kleonymos_korkyra_event.4
            }
        }
    }
}

kleonymos_korkyra_event.3 = {
    type = country_event 
    title = kleonymos_korkyra_event.3.t #The defeat of Kleonymos
    desc = kleonymos_korkyra_event.3.desc 
    left_portrait = current_ruler
    picture = shrine_city
    
    immediate = {
        c:BAR = {
            every_army = {
                limit = {
                    commander = char:176
                    exists = yes
                }
                every_sub_unit = { 
                    destroy_subunit = yes
                }
                destroy_unit = yes
            }
            every_army = {
                limit = {
                    unit_location = {
                        is_in_area = epirus_area
                    }
                    exists = yes
                }
                every_sub_unit = { 
                    destroy_subunit = yes
                }
                destroy_unit = yes
            }
        } 
        char:176 = {
            move_country = {
                COUNTRY = c:SPA
            }
        }
        if = {
            limit = {
                char:176 = {
                    is_alive = yes
                }
            }
            c:SPA = {
                trigger_event = {
                    id = kleonymos_korkyra_event.5
                }
            }
        }
        if = {
            limit = {
                char:176 = {
                    is_alive = no
                }
            }
            c:SPA = {
                trigger_event = {
                    id = kleonymos_korkyra_event.6
                }
            }
        }
    }

    option = {
        name = kleonymos_korkyra_event.3.a
        add_stability = 10
        current_ruler = {
            add_popularity = 10
        }
    }
}

kleonymos_korkyra_event.4 = {
    type = country_event
    title = kleonymos_korkyra_event.4.t #Kleonymos' Victory
    desc = kleonymos_korkyra_event.4.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = looting_dishonor

    immediate = {
        p:470 = {
            random_pops_in_province = {
                kill_pop = yes
            }
            random_pops_in_province = {
                kill_pop = yes
            }
            random_pops_in_province = {
                kill_pop = yes
            }
            random_pops_in_province = {
                kill_pop = yes
            }
            set_controller = root
        }
        c:BAR = {
            every_army = {
                limit = {
                    commander = char:176
                    exists = yes
                }
                every_sub_unit = { 
                    destroy_subunit = yes
                }
                destroy_unit = yes
            }
            every_army = {
                limit = {
                    unit_location = {
                        is_in_area = epirus_area
                    }
                    exists = yes
                }
                every_sub_unit = { 
                    destroy_subunit = yes
                }
                destroy_unit = yes
            }
        }
    }

    option = {
        name = kleonymos_korkyra_event.4.a #Let us give Kleonymus the wealth he wants
        add_treasury = -300
        char:176 = {
            add_gold = 300
            move_country_with_close_family_effect = {
                COUNTRY = c:SPA 
            }
        }
        scope:korkyra_defender = {
            current_ruler = {
                add_popularity = -10
            }
        }
        c:SPA = {
            trigger_event = {
                id = kleonymos_korkyra_event.7
            }
        }
        ai_chance = {
            factor = 25
        }
    }

    option = {
        name = kleonymos_korkyra_event.4.b #Korkyra is under Kleonymus' control now,
        custom_tooltip = kleonymos_korkyra_event.4.b_tt
        hidden_effect = {
            p:470 = {
                define_pop = {
                    type = nobles
                    culture = peloponnesian
                    religion = roman_pantheon
                }
                define_pop = {
                    type = nobles
                    culture = peloponnesian
                    religion = roman_pantheon
                }
                define_pop = {
                    type = citizen
                    culture = peloponnesian
                    religion = roman_pantheon
                }
                define_pop = {
                    type = citizen
                    culture = peloponnesian
                    religion = roman_pantheon
                }
                create_country = {
                    name = {
                        name = KRK
                        adjective = KRK_ADJ
                    }
                    change_country_color = light_yellow
                    set_country_heritage = spartan_heritage
                    change_government = tyrannic_monarchy
                    change_country_flag = SPARTAN_KORKYRA
                    save_scope_as = spartan_korkyra_country
                    add_treasury = 300
                    if = {
                        limit = {
                            NOT = {
                                primary_culture = peloponnesian
                            }
                        }
                        set_primary_culture_cleanup_effect = {
                            NEW_PRIMARY_CULTURE = peloponnesian
                            MAKE_OLD_CULTURE_INTEGRATED = yes
                        }
                    }
                    set_country_religion = roman_pantheon
                }
            }    
            char:176 = {
                move_country_with_close_family_effect = { 
                    COUNTRY = scope:spartan_korkyra_country
                }
            }
            scope:spartan_korkyra_country = {
                set_as_ruler = char:176
             }
            c:SPA = { 
                make_subject = {
                    target = scope:spartan_korkyra_country
                    type = subject_colony
                }
            }
        }
        scope:korkyra_defender = {
            add_stability = -5
            current_ruler = {
                add_popularity = -20
            }
        }
        c:SPA = {
            trigger_event = {
                id = kleonymos_korkyra_event.8
            }
        }
        ai_chance = {
            factor = 75
        }
    }
}

kleonymos_korkyra_event.5 = { #Kleonymos Suffers Defeat in Korkyra
    type = country_event
    title = kleonymos_korkyra_event.5.t
    desc = kleonymos_korkyra_event.5.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = ship_in_storm

    option = {
        name = kleonymos_korkyra_event.5.a
        char:176 = {
            add_popularity = -20
            add_prominence = -50
        }        
    }
}

kleonymos_korkyra_event.6 = { #Kleonymos Dies
    title = kleonymos_korkyra_event.6.t
    desc = kleonymos_korkyra_event.6.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = ship_in_storm

    option = {
        name = kleonymos_korkyra_event.6.a      
    }
}

kleonymos_korkyra_event.7 = { #Kleomynos returns home in glory
    type = country_event
    title = kleonymos_korkyra_event.7.t
    desc = kleonymos_korkyra_event.7.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = diadochi_legion_carrying_standard

    immediate = {
        char:176 = {
            add_prominence = 100
            add_popularity = 75
        }
    }

    option = {
        name = kleonymos_korkyra_event.7.a
    }
}

kleonymos_korkyra_event.8 = { #Kleomynos establishes a spartan colony in patavium
    type = country_event
    title = kleonymos_korkyra_event.8.t
    desc = kleonymos_korkyra_event.8.desc
    left_portrait = current_ruler
    right_portrait = char:176
    picture = city_siege_honor

    option = {
        name = kleonymos_korkyra_event.8.a
        c:SPA = {
            make_subject = {
                target = scope:spartan_korkyra_country
                type = subject_colony
            }
        }
    }
}